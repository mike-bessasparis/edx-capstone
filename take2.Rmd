---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(caret)


edx <- readRDS(file = "./rda/full_edx.rds")
validation <- readRDS (file = "./rda/full_Validation.rds")

#edx <- readRDS(file = "./rda/small_edx.rds")
#validation <- readRDS (file = "./rda/small_Validation.rds")

#edx <- readRDS(file = "./rda/mini_edx.rds")
#validation <- readRDS (file = "./rda/mini_Validation.rds")


```


```{r}

train_set <- edx
test_set <- validation

RMSE <- function(true_ratings, predicted_ratings) {
  sqrt(mean((true_ratings - predicted_ratings)^2))
}

#rm(edx, validation)

```

## Feature Engineering (from EDA)
```{r}
library(lubridate)

# factorize userId and movieId
# create a reviewed_date feature
train_set <- train_set %>%
  mutate(userId = factor(userId),
         movieId = factor(movieId),
         review_date = date(as_datetime(timestamp))) %>% 
  select(-timestamp)
test_set <- test_set %>%
  mutate(userId = factor(userId),
         movieId = factor(movieId),
         review_date = date(as_datetime(timestamp))) %>% 
  select(-timestamp)


# create a rated_year feature
train_set <- train_set %>%
  mutate(reviewed_year = as.integer(year(review_date)))
test_set <- test_set %>%
  mutate(reviewed_year = as.integer(year(review_date)))


# create released_year and movie_age_at_rating features
train_set <- train_set %>%
  mutate(movie_release_year = as.integer(str_extract(str_extract(title, "\\(\\d{4}\\)"), "\\d{4}")),
         movie_age_at_rating = year(review_date) - movie_release_year) %>% 
  select(-title)
test_set <- test_set %>%
  mutate(movie_release_year = as.integer(str_extract(str_extract(title, "\\(\\d{4}\\)"), "\\d{4}")),
         movie_age_at_rating = year(review_date) - movie_release_year) %>% 
  select(-title)

train_set <- train_set %>% 
  select(-genres)
test_set <- test_set %>% 
  select(-genres)


```



## Custom Model (Netflix)
```{r}

# r = mu + b_i(t) + b_u

# find the overall average rating
mu <- mean(train_set$rating)

# find b_i(t), the rating bias for each movie as a function of time (year)
lambda1 <- 3
movie_time_bias <- train_set %>% 
  group_by(movieId, reviewed_year) %>% 
  summarize(b_i_time = sum(rating - mu) / (n() + lambda1))

# find the rating bias for each user
# (the "leftover" after finding b_i)
lambda2 <- 5
user_avgs <- train_set %>% 
  left_join(movie_time_bias, by = c("movieId", "reviewed_year")) %>% 
  group_by(userId) %>% 
  summarize(b_u = sum(rating - mu - b_i_time) / (n() + lambda2) )

# combine and make predictions
predicted_ratings <- test_set %>% 
  left_join(movie_time_bias, by = c("movieId", "reviewed_year")) %>% 
  mutate(b_i_time = if_else(is.na(b_i_time), 0, b_i_time)) %>%   
  left_join(user_avgs, by = "userId") %>% 
  mutate(pred = mu + b_i_time + b_u)

predicted_ratings <- predicted_ratings %>% 
  select(userId, movieId, pred)

q <- RMSE(test_set$rating, predicted_ratings$pred)

rm(movie_time_bias, predicted_ratings, user_avgs, lambda1, lambda2, mu)

```

## XGBoost
```{r}

fitControl <- trainControl(method = "cv", number = 10)

xgbGrid <- expand.grid(gamma = 0,
                       min_child_weight = 1,
                       nrounds = 50,
                       max_depth = 3,
                       eta = 0.4,
                       colsample_bytree = 0.8,
                       subsample = 1)

start <- Sys.time()

fit <- train(rating ~ userId + movieId + reviewed_year,
             data = train_set,
             method = "xgbTree",
             tuneGrid = xgbGrid,
             trControl = fitControl)

end <-Sys.time()
mjb <- end - start

q <- predict(fit, test_set)

final_xgb_predictions <- data.frame(userId = as.character(test_set$userId), movieId = as.character(test_set$movieId), xgb_pred = q)

RMSE_xgb <- RMSE(test_set$rating, q)


```

