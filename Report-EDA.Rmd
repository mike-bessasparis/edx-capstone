---
title: "Report - Exploratory Data Analysis"
output: html_notebook
---

```{r echo=FALSE, results='hide'}

library(tidyverse)
library(ggthemes)
library(lubridate)

edx <- data.table::fread("./data/train.csv")

# edx <- readRDS(file = "./rda/full_edx.rds")
# validation <- readRDS (file = "./rda/full_Validation.rds")

#edx <- readRDS(file = "./rda/small_edx.rds")
#validation <- readRDS (file = "./rda/small_Validation.rds")


```

***
# Data Exploration
## Summary
The data is from the GroupLens research lab at the University of Minnesota.  The data consists of **`r nrow(edx)`** observations of **`r length(edx)`** variables. The data spans the years from **`r year(min(as_datetime(edx$timestamp)))`** to **`r year(max(as_datetime(edx$timestamp)))`**.

The `userId` variable is an integer representation of an actual MovieLens userId which has been anonymized to protect privacy.  The `movieId` is the actual MovieLens ID.  Ratings are made on a 5-star scale with half-star increments.  Timestamps represent seconds since midnight Coordinated Universal Time (UTC) of January 1, 1970.  The title includes the title and year the movie was released.  The `genres` variable is a concatenation of all genres which apply to a specific movie.
```{r echo = TRUE}

summary(edx)
head(edx)

```

# Missing data, label encoding, and factorizing variables
Do any variables contain missing values?
```{r echo = TRUE}

edx_working <- edx
NAcol <- which(colSums(is.na(edx)) > 0)

```
There are `r length(which(colSums(is.na(edx)) > 0))` columns with at least one NA.

There are no labels that are ordinal and should be encoded as a number.

We will convert `userId` and `movieId` from an integer to a factor.
```{r echo = TRUE}

edx <- edx %>%
  mutate(userId = factor(userId),
         movieId = factor(movieId))

```



# Response Variable
```{r echo = TRUE}

summary(edx$rating)

```
The `ratings` response variable shows a predominance of whole-star ratings.  This may be due at least two factors: the rating data does not include half-star ratings until 2003 and users may have a strong preference for whole-star ratings.  Looking at either the whole-star or half-star ratings we see a somewhat normal distribution which is strongly left skewed.
```{r}

edx %>% ggplot(aes(x=rating)) +
  geom_histogram(binwidth = .5, col="grey") +
  scale_x_continuous(breaks = seq(.5, 5, .5)) +
  labs(title = "Ratings") +
  theme_economist_white()

```
## Other Variables
```{r echo = TRUE, results = "hide"}
# unconcatenate the genres to count them
rated_movies_grouped_by_genre <- edx %>% 
  separate_rows(genres, sep = "\\|") %>% 
  group_by(genres) 

length(unique(rated_movies_grouped_by_genre))

```
In the dataset there are:

- **`r length(unique(rated_movies_grouped_by_genre <- edx %>% separate_rows(genres, sep = "\\|") %>% group_by(genres) ))`** unique movie genres.
- **`r length(unique(edx$userId))`** unique users
- **`r length(unique(edx$movieId))`** unique movies rated

### Genres
Number of reviewed movies in each genre.  Note that a movie may be tagged with several genres, e.g., the movie "Boomerang" is classified as both a "Comedy" and a "Romance."
```{r echo = TRUE}

edx %>% 
  separate_rows(genres, sep = "\\|") %>% 
  group_by(genres) %>% 
  summarise(count = n()) %>% 
  ggplot() +
    geom_col(aes(x = reorder(genres, -count), y = count)) +
    coord_flip() +
    xlab("Genre") +
    ylab("Number of Movies") +
    labs(title = "Movies in Each Genre") +
    theme_economist_white() +
    theme(axis.text.y.left = element_text(hjust = 1),
          panel.grid.major = element_blank(),
          axis.ticks.y.left = element_line(),
          axis.ticks.x.bottom = element_blank())

```

Which movies did not have a genre listed? 
```{r echo = TRUE}

no_genre <- edx %>% filter(genres == "(no genres listed)")
no_genre


```

### Users
Number of movies rated by each user.
```{r echo = TRUE}

library(lubridate)
library(tidyverse)

q <- edx %>% 
  group_by(userId) %>% 
  summarise(num_of_movies_rated = n())

summary(q$num_of_movies_rated)

```


```{r echo = TRUE}
q %>% ggplot() +
  stat_count(geom = "bar", aes(x = num_of_movies_rated)) +
  labs(title = "Number of Movies Rated by Users") +
  theme_economist_white()
  
```

### Movies
Do some movies receive more reviews than others?
```{r echo = TRUE}
library(lubridate)
library(tidyverse)

q <- edx %>% 
  group_by(movieId) %>% 
  summarise(num_of_reviews_movie = n())

summary(q$num_of_reviews_movie)

```

How are the reviews/movie distributed?
```{r echo = TRUE}

q %>% ggplot() +
  stat_count(geom = "bar", aes(x = num_of_reviews_movie)) +
  labs(title = "Number of Reviews/Movie") +
  theme_economist_white()
  
```

What are the most reviewed movies...
```{r echo = TRUE}

edx %>% 
  group_by(title) %>% 
  summarise(count = n()) %>% 
  arrange(-count) %>% 
  top_n(5)

```
 ...and least reviewed movies?
```{r echo = TRUE}

edx %>% 
  group_by(title) %>% 
  summarise(count = n()) %>% 
  arrange(count) %>% 
  top_n(5)

```
### Timestamp
```{r echo = TRUE}

edx_working <- edx %>% 
  mutate(review_date = date(as_datetime(timestamp)))

summary(edx_working$review_date)

```
How does the number of movies reviewed change over time?
```{r echo = TRUE}

q <- edx_working %>% 
  mutate(review_period = round_date(review_date, unit = "months")) %>% 
  group_by(review_period) %>% 
  summarise(count = n())

q %>% ggplot(aes(x = review_period, y = count)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  labs(title = "Number of Reviews Over Time") +
  scale_x_date(name = "Month") +
  theme_economist_white()


```



There are no continuous numeric predictors to correlate with `rating` in the given data - `userId` and `movieId` are discrete while `timestamp` is a date.  However, we can explore to find out what role time plays.  

Let's look at the overall average movie rating over time.
```{r echo = TRUE}

# first change the timestamp into a human-readable format
edx_working <- edx %>% 
  mutate(review_date = date(as_datetime(timestamp)))

q <- edx_working %>% 
  mutate(review_period = round_date(review_date, unit = "month")) %>% 
  group_by(review_period) %>% 
  summarise(avg_rating = mean(rating))

q %>% ggplot(aes(x = review_period, y = avg_rating)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  scale_x_date(name = "Month") +
  scale_y_continuous(limits = c(.5, 5)) +
  labs(title = "Average Rating Over Time") +
  theme_economist_white()


```

Does a particular movie's `average rating` change over time?  There are too many movies to visualize this effectively so we will select a small random sample.  For reference, the dashed horizontal line is the overall average rating.

```{r echo = TRUE, results = "hide"}

# change the timestamp into date object
edx_working <- edx %>% 
  mutate(review_date = date(as_datetime(timestamp)))

mu <- mean(edx_working$rating)

t <- sample(edx_working$movieId, 25)

q <- edx_working %>% 
  filter(movieId %in% t) %>% 
  mutate(review_period = round_date(review_date, unit = "year")) %>% 
  group_by(movieId, review_period) %>% 
  summarise(avg_rating = mean(rating))

q %>% ggplot(aes(x = review_period, y = avg_rating)) +
  geom_line(color = "blue") +
  geom_hline(yintercept = mu, color = "grey", linetype = "dashed") +
  scale_x_date(name = "Year") +
  scale_y_continuous(limits = c(.5, 5), breaks = NULL) +
  labs(title = "Average Rating for Individual Movies Over Time") +
  facet_wrap(~ movieId) 
  

```

How does rating change related to the `movie's age` at the time of the review?  For reference, the dashed horizontal line is the overall average rating.
```{r echo = TRUE}

mu <- mean(edx$rating)

edx_working <- edx %>%
  mutate(movie_release_year = as.integer(str_extract(str_extract(title, "\\(\\d{4}\\)"), "\\d{4}")),
         rating_date = as_datetime(timestamp),
         movie_age_at_rating = year(rating_date) - movie_release_year) 

edx_working <- edx_working %>% 
  group_by(movie_age_at_rating) %>%
  summarise(avg_rating = mean(rating))

edx_working %>% 
  ggplot(aes(x = movie_age_at_rating, y = avg_rating)) +
    geom_point() +
    geom_smooth(se = FALSE) +
    geom_hline(yintercept = mu, linetype = "dashed") +
    scale_y_continuous(limits = c(.5, 5)) +
    theme_economist_white()

```

Does a particular user's average rating change over time?  There are too many users to visualize this effectively so we will select a small random sample.  For reference, the dashed horizontal line is the overall average rating.
```{r echo = TRUE, results = "hide"}

mu <- mean(edx$rating)

# change the timestamp into date object
edx_working <- edx %>% 
  mutate(review_date = date(as_datetime(timestamp)))

t <- sample(edx_working$userId, 25)

q <- edx_working %>% 
  filter(userId %in% t) %>% 
  mutate(review_period = round_date(review_date, unit = "year")) %>% 
  group_by(userId, review_period) %>% 
  summarise(avg_rating = mean(rating))

q %>% ggplot(aes(x = review_period, y = avg_rating)) +
  geom_line(color = "blue") +
  geom_hline(yintercept = mu, color = "grey", linetype = "dashed") +
  scale_x_date(name = "Year") +
  scale_y_continuous(limits = c(.5, 5), breaks = NULL) +
  labs(title = "Average Rating for Individual Users Over Time") +
  facet_wrap(~ userId) 
  
```

## New variables that might correlate with `rating`
How does rating change related to `user's length of time reviewing` at the time of the review?  For reference, the dashed horizontal line is the overall average rating.
```{r echo = TRUE}

mu <- mean(edx$rating)

q <- edx %>% 
  group_by(userId) %>% 
  summarise(user_first_rating = date(as_datetime(min(timestamp))))

edx_working <- edx %>% 
  left_join(q, by = "userId") %>% 
  mutate(rating_date = date(as_datetime(timestamp)),
         days_since_first_rating =  as.integer(rating_date - user_first_rating))

edx_working <- edx_working %>% 
  group_by(days_since_first_rating) %>%
  summarise(avg_rating = mean(rating))

edx_working %>% 
  ggplot(aes(x = days_since_first_rating, y = avg_rating)) +
    geom_point() +
    geom_smooth(se = FALSE) +
    scale_y_continuous(limits = c(.5, 5)) +
    geom_hline(yintercept = mu, linetype = "dashed") +
    theme_economist_white()

```


Is there a relationship between the `number of reviews of a movie` and the rating of that movie?  For reference, the dashed horizontal line is the overall average rating.
```{r echo = TRUE}

mu <- mean(edx$rating)

q <- edx %>% 
  group_by(movieId) %>% 
  summarise(num_of_reviews_of_movie = n())

edx_working <- edx %>%
  left_join(q, by = "movieId")

edx_working <- edx_working %>% 
  group_by(num_of_reviews_of_movie) %>%
  summarise(avg_rating = mean(rating))

edx_working %>% 
  ggplot(aes(x = num_of_reviews_of_movie, y = avg_rating)) +
    geom_point() +
    geom_smooth(se = FALSE) +
    geom_hline(yintercept = mu, linetype = "dashed") +
    scale_y_continuous(limits = c(.5, 5)) +
    theme_economist_white()

```

Is there a relationship between the `number of movies a user has reviewed` and that users ratings?
```{r}

mu <- mean(edx$rating)

edx_working <- edx %>% 
  group_by(userId) %>% 
  summarise(num_ratings = n(), avg_rating = mean(rating))

edx_working %>% ggplot(aes(x = num_ratings, y = avg_rating)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  geom_hline(yintercept = mu, linetype = "dashed") +
  theme_economist_white()


```

How does genre affect a movie's rating?
```{r echo = TRUE}

mu <- mean(edx$rating)

edx_working <- edx
#
# Separate and factorize the genres
#
edx_working <- edx_working %>% 
  separate_rows(genres, sep = "\\|") %>% 
  mutate(genre = factor(genres))

# combined genre and rating
edx_working <- edx_working %>% 
  group_by(genres) %>% 
  summarise(avg_rating = mean(rating))
  
edx_working %>% 
  ggplot(aes(x = reorder(genres, avg_rating), y = avg_rating)) +
    geom_point() +
    geom_hline(yintercept = mu, linetype = "dashed") +
    scale_y_continuous(limits = c(.5, 5)) +
    scale_x_discrete(name = "Genre") +
    theme_economist_white() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

```



